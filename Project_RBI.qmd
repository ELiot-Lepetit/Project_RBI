---
title: "Project_RBI"
author: "Aashish Sukhija & Eliot Lepetit"
format: 
  html: default
  pdf: default
---

## Import datasets

```{r}
#| message: false
#| warning: false
here::i_am("Project_RBI.Rproj")
library(here)       
library(readxl)     
library(tidyr)  
library(stringr)
library(dplyr)
library(vroom)
library(ggplot2)
library(readxl)

theme_set(theme_bw())
```

```{r}
suppressMessages({
Literacy_data <- read_excel("State-wise Literacy Rate.XLSX", skip = 3)
Birth_data <- read_excel("_State-wise Birth Rate.XLSX", skip = 3, sheet = 2)
Sex_data <- read_excel("State-wise Sex Ratio.XLSX", skip = 3)
Death_data <- read_excel("State-wise Death Rate.XLSX", skip = 3, sheet = 2)
Pop_data <- read_excel("State-wise Total Population.XLSX", skip = 3)
IMR_data <- read_excel("State-wise Infant Mortality Rate.XLSX", skip = 2, sheet = 2)
TFR_data <- read_excel("State-wise Total Fertility Rate.XLSX", skip = 2, sheet = 2)
Life_data <- read_excel("State-wise Life Expectancy.XLSX", skip = 2, sheet = "T_14(vi)")
Health_Exp_data <- read_excel("State-wise Public Expenditure on Health.XLSX", skip = 3)
NSDP1_data <- read_excel("Net State Domestic Product (At Constant Prices).XLSX", sheet = 1, skip = 4)
NSDP2_data <- read_excel("Net State Domestic Product (At Constant Prices).XLSX", sheet = 2, skip = 4)
NSDP3_data <- read_excel("Net State Domestic Product (At Constant Prices).XLSX", sheet = 3, skip = 4)

#Create a directory to store CSV files
if (!dir.exists(here("data"))) {
  dir.create(here("data"))
}

#Save each dataset as a CSV file
write.csv(Literacy_data, here("data", "State-wise_Literacy_Rate.csv"), row.names = FALSE)
write.csv(Birth_data, here("data", "State-wise_Birth_Rate.csv"), row.names = FALSE)
write.csv(Sex_data, here("data", "State-wise_Sex_Ratio.csv"), row.names = FALSE)
write.csv(Death_data, here("data", "State-wise_Death_Rate.csv"), row.names = FALSE)
write.csv(Pop_data, here("data", "State-wise_Total_Population.csv"), row.names = FALSE)
write.csv(IMR_data, here("data", "State-wise_Infant_Mortality_Rate.csv"), row.names = FALSE)
write.csv(TFR_data, here("data", "State-wise_Total_Fertility_Rate.csv"), row.names = FALSE)
write.csv(Life_data, here("data", "State-wise_Life_Expectancy.csv"), row.names = FALSE)
write.csv(Health_Exp_data, here("data", "State-wise_Public_Expenditure_on_Health.csv"), row.names = FALSE)
write.csv(NSDP1_data, here("data", "Net_State_Domestic_Product_1.csv"), row.names = FALSE)
write.csv(NSDP2_data, here("data", "Net_State_Domestic_Product_2.csv"), row.names = FALSE)
write.csv(NSDP3_data, here("data", "Net_State_Domestic_Product_3.csv"), row.names = FALSE)
})
```

We finally load the datasets in CSV format from the "data" directory we just created :
```{r}
suppressMessages({
Literacy_data <- read.csv(here("data", "State-wise_Literacy_Rate.csv"))
Birth_data <- read.csv(here("data", "State-wise_Birth_Rate.csv"))
Sex_data <- read.csv(here("data", "State-wise_Sex_Ratio.csv"))
Death_data <- read.csv(here("data", "State-wise_Death_Rate.csv"))
Pop_data <- read.csv(here("data", "State-wise_Total_Population.csv"))
IMR_data <- read.csv(here("data", "State-wise_Infant_Mortality_Rate.csv"))
TFR_data <- read.csv(here("data", "State-wise_Total_Fertility_Rate.csv"))
Life_data <- read.csv(here("data", "State-wise_Life_Expectancy.csv"))
Health_Exp_data <- read.csv(here("data", "State-wise_Public_Expenditure_on_Health.csv"))
NSDP1_data <- read.csv(here("data", "Net_State_Domestic_Product_1.csv"))
NSDP2_data <- read.csv(here("data", "Net_State_Domestic_Product_2.csv"))
NSDP3_data <- read.csv(here("data", "Net_State_Domestic_Product_3.csv"))
})
```

## Cleaning data

### Merging and cleaning the NSDP datasets to have all states in one database

```{r}
#| message: false
#| warning: false
NSDP_merged <- NSDP1_data %>%
  full_join(NSDP2_data, by = "Year") %>%
  full_join(NSDP3_data, by = "Year")

# Removing unused rows (we keep the data only for years after 2011)
NSDP_merged <- NSDP_merged[c(11:16, 25:29, 38:44, 53:65), ] 
# Transforming missing values character as "NAs" and changing the dates format
NSDP_merged <- NSDP_merged %>% mutate(across(everything(), ~ ifelse(. == "-", NA, .))) %>%
  mutate(Year = as.numeric(sub("-.*", "", Year)))

# We pivot the database to have a variable "State" in order to merge with other datasets
NSDP_long <- NSDP_merged %>%
  mutate(across(-Year, as.character)) %>%
  pivot_longer(
    cols = -Year,         
    names_to = "State",    
    values_to = "Value"     
  ) 

NSDP_clean <- NSDP_long %>%
  pivot_wider(
    names_from = Year,     
    values_from = Value
  )  %>%
  mutate(across(-State, as.numeric))

rm(NSDP1_data, NSDP2_data, NSDP3_data)

```


#### GGplot for the NSDP by state
For visibility, we only display the first five states:  `r paste(NSDP_clean$State[1:5], collapse = ", ")`.
```{r}
#| message: false
#| warning: false
NSDP_plot <- NSDP_clean %>%
  slice(1:5) %>%
  pivot_longer(
    cols = -State,          
    names_to = "Year",       
    values_to = "Value"
  ) %>%
    mutate(Year = as.numeric(Year))

library(scales)
ggplot(NSDP_plot, aes(x = Year, y = Value, color = State)) +
  geom_line(size = 1) +                
  labs(
    title = "Trends in NSDP by State",
    x = "Year",
    y = "NSDP Value (in Crores)"
  ) +
  scale_y_continuous(
    breaks = seq(0, max(NSDP_plot$Value, na.rm = TRUE), by = 100000),  
    labels = label_number(scale_cut = cut_short_scale())              
  ) +
  scale_x_continuous(
    breaks = seq(min(NSDP_plot$Year, na.rm = TRUE), max(NSDP_plot$Year, na.rm = TRUE), by = 2) 
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    legend.title = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1), 
    panel.grid.major.y = element_line(color = "gray", linetype = "dotted"))  
```


### Cleaning the other datasets to prepare the merging

#### State-wise Birth Rate
```{r}
#| message: false
#| warning: false
Birth_data <- Birth_data %>%  rename(State = State.Union.Territory ) %>%
      rename_with(~ sub("^X", "", .)) %>%
    mutate(across(-State, as.numeric)) %>% 
    slice(-c(39, 40)) %>%
  mutate(across(where(is.numeric), ~ round(., 1))) #rounding the data to one decimal place
```

#### State-wise Death Rate
```{r}
#| message: false
#| warning: false
Death_data <- Death_data %>%  rename(State = `State.Union.Territory`) %>%
      rename_with(~ sub("^X", "", .)) %>%
    mutate(across(-State, as.numeric)) %>%
  slice(-c(39, 40)) %>%
   mutate(across(where(is.numeric), ~ round(., 1))) #rounding the data to one decimal place
```

#### State-wise Public Expenditure on Health
```{r}
#| message: false
#| warning: false
Health_Exp_data <- Health_Exp_data %>%
  rename(State = `State.Union.Territory`) %>%                   
  rename_with(~ gsub("^X|\\..*", "", .)) %>%                     
  mutate(across(-State, as.numeric)) %>%                        
  mutate(across(where(is.numeric), ~ round(., 1))) %>%           
  slice(-c(37, 38))                                             
```

#### State-wise Literacy Rate
```{r}
#| message: false
#| warning: false
Literacy_data <- Literacy_data %>% rename(State = `State.Union.Territory`) %>%
        rename_with(~ sub("^X", "", .)) %>%
  mutate(across(-State, as.numeric)) %>%
  mutate(across(where(is.numeric), ~ round(., 1))) %>%
  slice(-c(37:40))
```

#### State-wise Total population
```{r}
#| message: false
#| warning: false
Pop_data <- Pop_data %>% rename(State = `State.Union.Territory`) %>%
        rename_with(~ sub("^X", "", .)) %>%
  slice(-c(37:43)) %>%
  mutate(across(everything(), ~ ifelse(. == "-", NA, .)))
```

#### State-wise Sex Ratio (Females per Thousand Males)
```{r}
#| message: false
#| warning: false
Sex_data <- Sex_data %>% rename(State = `State.Union.Territory`) %>%
      rename_with(~ sub("^X", "", .)) %>%
  slice(-c(37:39))  %>%
  mutate(across(everything(), ~ ifelse(. == "-", NA, .)))
```

#### State-wise Total Fertility Rate (number of children that would be born per woman, assuming no female mortality at childbearing age during the reference period)
```{r}
#| message: false
#| warning: false
TFR_data <- TFR_data %>%  rename(State = `Year`) %>%
    rename_with(~ sub("^X", "", .)) %>%
    mutate(across(-State, as.numeric)) %>%
  slice(-c(24:26)) %>%
   mutate(across(where(is.numeric), ~ round(., 1)))
```
